!function(){function t(t,n,e,a){var r=e/2,i=8*a,o=4*a,l=r-o/2,c=r+i,u=Math.asin(l/c),d=Math.sqrt(1-Math.pow(l/c,2))*c,f=e+i+o,v=t/2,h=document.createElement("canvas");h.width=t,h.height=f;var s=h.getContext("2d");s.lineJoin=s.lineCap="round",s.translate(v,f-r),s.moveTo(-v+o,-l),s.lineTo(-d,-l),s.arc(0,0,c,-Math.PI+u,-u),s.lineTo(v-o,-l),s.strokeStyle="#555",s.lineWidth=o,s.stroke();var p=n-f;return{paint:function(t){t.drawImage(h,0,p)}}}function n(t,n){var e=document.createElement("canvas");e.width=t,e.height=n;var a=e.getContext("2d");return{c:a,canvas:e,clear:function(){a.fillStyle="rgba(0, 0, 0, 0.4)",a.fillRect(0,0,t,n)}}}function e(t,n,e,a){for(var r=16,i=r,o=2*Math.PI,l=[],c=0;6>c;c++){var u=p(2*a,2*a),d=p(2*a,2*a);l.push({x:t+u[0],y:n+u[1],dx:d[0],dy:d[1]})}return{paint:function(c){i==r&&e.paint(c,t,n);for(var u=0;u<l.length;u++){var d=l[u],f=d.x,v=d.y;c.beginPath(),c.moveTo(f,v),c.fillStyle=e.color,c.arc(f,v,4*i/r*a,0,o),c.fill()}},tick:function(){for(var t=0;t<l.length;t++){var n=l[t];n.x+=n.dx,n.y+=n.dy}return i--,i?void 0:!0}}}function a(t){var n=[];return{add:function(a,r,i){n.push(e(a,r,i,t))},paint:function(t){for(var e=0;e<n.length;e++)n[e].paint(t)},tick:function(){for(var t=0;t<n.length;t++)n[t].tick()&&(n.splice(t,1),t--)}}}function r(t,n,e){for(var a=[],r=0;r<t.length;r++)for(var i=t[r],o=0;o<n.length;o++){var l=n[o],c=l.x-i.x,u=l.y-i.y,d=Math.hypot(c,u);if(e>d){a.push({movingBubble:i,stillBubble:l,distance:d});break}}return a}function i(t){var n=[];return{add:function(e,a,r){n.push(o(e,a,r,t))},paint:function(t){for(var e=0;e<n.length;e++)n[e].paint(t)},tick:function(){for(var t=0;t<n.length;t++)n[t].tick()&&(n.splice(t,1),t--)}}}function o(t,n,e,a){var r=32,i=r,o=6*(2*Math.random()-1)*a,l=0;return{paint:function(a){a.globalAlpha=i/r,e.paint(a,t,n),a.globalAlpha=1},tick:function(){return t+=o,n+=l,l+=a,o*=.95,i--,i?void 0:!0}}}function l(t,n,e,a,r,i){var o=r.createLinearGradient(0,0,0,n);o.addColorStop(0,"rgba(255, 255, 255, 0)"),o.addColorStop(1,"rgba(255, 255, 255, 0.2)");var l=2*Math.max(t,n),c=t/2,u=n-e;return{paint:function(t,n,e){var r=n-c,d=e-u,f=Math.hypot(r,d),v=r*l/f,h=d*l/f;-i>d/f&&(t.beginPath(),t.moveTo(c,u),t.lineTo(c+v,u+h),t.lineWidth=a,t.lineCap="round",t.strokeStyle=o,t.stroke())}}}function c(t,n,e){var a="scale("+1/e+")",r=(t-t*e)/2,i=(n-n*e)/2;a+=" translate("+r+"px, "+i+"px)";var o=document.createElement("canvas");return o.style.transform=a,o.className="MainCanvas",o.width=t,o.height=n,o}function u(){function e(){var t=k();return h(T,B,x,t)}function o(){requestAnimationFrame(function(){var t=Date.now();R.clear(),Q.clearRect(0,0,T,B),G.paint(O),H.paint(O),W.paint(O),J&&Z.paint(O,q,X),$&&$.paint(O),Y.paint(O),A.paint(O),D.paint(O),F.visible&&F.paint(O),Q.drawImage(R.canvas,0,0),N.innerHTML="repaint "+(Date.now()-t)})}function u(){var t=Date.now();W.tick(),Y.tick(),A.tick(),D.tick(),F.visible&&F.tick(),$&&$.tick();for(var n=r(Y.movingBubbles,W.stillBubbles,M),e=0;e<n.length;e++){var a=n[e],i=a.movingBubble;i.shiftBack(m-a.distance),d(i),Y.remove(i)}E.innerHTML="tick "+(Date.now()-t),o()}function d(t){W.add(t),nn++,nn===en&&(nn=0,W.shift())}var v=devicePixelRatio,s=innerWidth*v,p=innerHeight*v,m=40*v,x=m/2,C=Math.sin(Math.PI/3)*m,w=x-1*v,M=2*w,k=S(w).next,I="MainPanel",E=document.createElement("div"),N=document.createElement("div"),P=document.createElement("div");P.className=I+"-debug",P.appendChild(N),P.appendChild(E);var T=s-s%m,B=p-p%m,R=n(T,B),O=R.c,G=t(T,B,m,v),L=Math.floor(s/m),A=a(v),D=i(v),H=y(T,B,m,v),W=b(B,x,L,m,k,C,A.add,D.add,H.add,function(){F.visible=!0});W.reset();var q,X,Y=f(T,B,x,M,d,v),F=g(T,B),J=!1,j=c(s,p,v),z=(s-T)/2,K=(p-B)/2,Q=j.getContext("2d");Q.translate(z,K);var U,V=.2,Z=l(T,B,x,M,Q,V),$=e(),_=null,tn=document.createElement("div");tn.className=I,tn.appendChild(j),tn.appendChild(P),tn.addEventListener("touchstart",function(t){if($&&$.ready&&!F.showing&&!F.hiding){if(F.visible)return F.hide(),void W.reset();if(null===_){var n=t.changedTouches[0];q=n.clientX*v-z,X=n.clientY*v-K,_=n.identifier,J=!0}}}),tn.addEventListener("touchmove",function(t){for(var n=t.changedTouches,e=0;e<n.length;e++){var a=n[e];a.identifier===_&&(q=a.clientX*v-z,X=a.clientY*v-K)}}),tn.addEventListener("touchend",function(t){for(var n=t.changedTouches,a=0;a<n.length;a++){var r=n[a];if(r.identifier===_){J=!1;var r=t.changedTouches[0],i=q-T/2,l=B-x-X,c=Math.hypot(i,l),u=i/c,d=-l/c;if(-V>d){var f=$.shape;Y.add(f,u,d),$=null,U=setTimeout(function(){$=e()},200),o(),_=null}}}});var nn=0,en=4;return addEventListener("keydown",function(t){32==t.keyCode&&u()}),setInterval(u,20),o(),{element:tn}}function d(t,n,e,a,r,i,o,l){var c=20*l,u=i*c,d=o*c,f={shape:r,x:t/2,y:n-e,paint:function(t){r.paint(t,f.x,f.y)},shiftBack:function(n){var a=Math.hypot(i,o);f.x-=i*n/a,f.y-=o*n/a;var r=e-f.x;r>0&&(f.x+=2*r);var l=f.x+e-t;l>0&&(f.x-=2*l)},tick:function(){f.x+=u,f.y+=d;var n=e-f.x;n>0&&(f.x+=2*n,i=-i,u=i*c);var a=f.x+e-t;return a>0&&(f.x-=2*a,i=-i,u=i*c),f.y<=e?(f.y=e,!0):void 0}};return f}function f(t,n,e,a,r,i){function o(t){l.splice(l.indexOf(t),1)}var l=[];return{movingBubbles:l,remove:o,add:function(r,o,c){var u=d(t,n,e,a,r,o,c,i);l.push(u)},paint:function(t){for(var n=0;n<l.length;n++)l[n].paint(t)},tick:function(){for(var t=0;t<l.length;t++){var n=l[t];n.tick()&&(r(n),o(n))}}}}function v(t,n){function e(t,n){var e=r[t];if(e){var i=e[n];i&&!d[i.id]&&i.shape==u&&a(i)}}function a(t){var n=t.colNumber,a=t.rowNumber;d[t.id]=t,f.push(t),e(n-2,a),e(n+2,a),e(n-1,a-1),e(n+1,a-1),e(n-1,a+1),e(n+1,a+1)}for(var r={},i=0;i<n.length;i++){var o=n[i];r[i]={};for(var l=0;l<o.length;l++){var c=o[l];r[i][c.rowNumber]=c}}var u=t.shape,d={},f=[];return a(t),f}function h(t,n,e,a){var r=t/2,i=n+e,o=6,l=2*e/o,c={ready:!1,shape:a,paint:function(t){a.paint(t,r,i)},tick:function(){o?(o--,i-=l):c.ready=!0}};return c}function s(t){function n(t,n){var r=a(t,n);if(r){var o=r.id;v[o]||(v[o]=!0,i.splice(i.indexOf(r),1),e(r))}}function e(t){var e=t.colNumber,a=t.rowNumber;n(e-1,a-1),n(e+1,a-1),n(e-2,a),n(e+2,a),n(e-1,a+1),n(e+1,a+1)}function a(t,n){var e=o[t];return e?e[n]:void 0}for(var r=[],i=[],o={},l=0;l<t.length;l++){var c=t[l];o[l]={};for(var u=0;u<c.length;u++){var d=c[u],f=d.rowNumber;f?(o[l][f]=d,i.push(d)):r.push(d)}}for(var v={},l=0;l<r.length;l++)e(r[l]);return i}function p(t,n){var e=Math.random()*Math.PI*2,a=t+Math.random()*n,r=Math.cos(e)*a,i=Math.sin(e)*a;return[r,i]}function g(t,n){function e(){r&&r--,r||(l.visible=!1,l.hiding=!1),o=r/i}function a(){i>r?r++:l.showing=!1,o=r/i}var r=0,i=24,o=0,l={tick:a,hiding:!1,showing:!1,visible:!1,hide:function(){l.showing=!1,l.tick=e,l.hiding=!0},paint:function(e){e.fillStyle="rgba(0, 0, 0, "+.7*o+")",e.fillRect(0,0,t,n)},show:function(){l.hiding=!1,l.tick=a,l.showing=!0}};return l}function m(t,n,e,a,r){var i={colNumber:r,id:Math.random(),rowNumber:a,x:t,y:n,shape:e,paint:function(n){e.paint(n,t,i.y)}};return i}function b(t,n,e,a,r,i,o,l,c,u){function d(t){w.push(t),k[t.colNumber].push(t),f(t)}function f(t){t.rowNumber>=E&&(T.gameOver=!0,u())}function h(t,e){for(var o=n+t*n,l=n-i-C,c=0;e>c;c++){var u=r(),f=m(o,l,u,0,t);d(f),p(f,y+S),o+=a,t+=2}}function p(t,n){var e=t.id;M[e]?M[e].steps+=n:M[e]={steps:n,bubble:t}}function g(t){w.splice(w.indexOf(t),1);var n=k[t.colNumber];n.splice(n.indexOf(t),1)}function b(){for(var t=0;t<w.length;t++){var n=w[t];p(n,y),n.rowNumber++,f(n)}N?h(1,e-1):h(0,e),N=!N,C+=i,S+=y}for(var y=4,x=i/y,C=0,S=0,w=[],M={},k=[],I=0;2*e-1>I;I++)k[I]=[];var E=Math.floor((t-a)/i),N=!1,P=3,T={gameOver:!1,shift:b,stillBubbles:w,add:function(t){var e=t.y,r=S*x-n,u=Math.round((e+r)/i);e=u*i-r;var f=(u+(N?1:0))%2?n:0,h=t.x;h=Math.round((h-f)/a)*a+f;var b=Math.floor(h/n)-1,y=m(h,e,t.shape,u,b);d(y),S&&p(y,S);var C=v(y,k);if(C.length>=P){c(C.length-P+1);for(var w=0;w<C.length;w++){var M=C[w];g(M),o(M.x,M.y,M.shape)}for(var I=s(k),w=0;w<I.length;w++){var E=I[w];g(E),l(E.x,E.y,E.shape)}}},isOdd:function(){return N},paint:function(t){for(var n=0;n<w.length;n++)w[n].paint(t)},reset:function(){T.gameOver=!1,M={},w.splice(0);for(var t in k)k[t].splice(0);b(),b(),b()},tick:function(){for(var t in M){var n=M[t];n.steps--,n.bubble.y+=x,n.steps||(delete M[t],t--)}S&&(S--,C-=x)}};return T}function y(t,n,e,a){var r=0,i=t-11*a,o=n-e+12*a,l="bold "+26*a+"px Arial, sans-serif";return{add:function(t){r+=t},paint:function(t){t.textAlign="right",t.textBaseline="top",t.font=l,t.fillStyle="#555",t.fillText(r,i,o)},reset:function(){r=0}}}function x(t){var n="hsl(220, 100%, 70%)",e=t+2,a=function(){var a=document.createElement("canvas");a.width=a.height=2*e;var r=a.getContext("2d"),i=-t/2,o=r.createRadialGradient(0,i,0,0,i,2*t);return o.addColorStop(0,n),o.addColorStop(.5,"hsl(220, 100%, 55%)"),o.addColorStop(1,n),r.fillStyle=o,r.translate(e,e),r.arc(0,0,t,0,2*Math.PI),r.fillStyle=o,r.fill(),a}();return{color:n,paint:function(t,n,r){t.drawImage(a,n-e,r-e)}}}function C(t){var n="hsl(100, 100%, 40%)",e=t+2,a=function(){var a=document.createElement("canvas");a.width=a.height=2*e;var r=a.getContext("2d"),i=-t/2,o=r.createRadialGradient(0,i,0,0,i,2*t);return o.addColorStop(0,n),o.addColorStop(.5,"hsl(100, 100%, 30%)"),o.addColorStop(1,n),r.fillStyle=o,r.translate(e,e),r.arc(0,0,t,0,2*Math.PI),r.fillStyle=o,r.fill(),a}();return{color:n,paint:function(t,n,r){t.drawImage(a,n-e,r-e)}}}function S(t){var n=[w(t),C(t),x(t),M(t),I(t),k(t)];return{next:function(){return n[Math.floor(Math.random()*n.length)]}}}function w(t){var n="hsl(5, 100%, 65%)",e=t+2,a=function(){var a=document.createElement("canvas");a.width=a.height=2*e;var r=a.getContext("2d"),i=-t/2,o=r.createRadialGradient(0,i,0,0,i,2*t);return o.addColorStop(0,n),o.addColorStop(.5,"hsl(5, 100%, 40%)"),o.addColorStop(1,n),r.fillStyle=o,r.translate(e,e),r.arc(0,0,t,0,2*Math.PI),r.fillStyle=o,r.fill(),a}();return{color:n,paint:function(t,n,r){t.drawImage(a,n-e,r-e)}}}function M(t){var n="hsl(300, 100%, 60%)",e=t+2,a=function(){var a=document.createElement("canvas");a.width=a.height=2*e;var r=a.getContext("2d"),i=-t/2,o=r.createRadialGradient(0,i,0,0,i,2*t);return o.addColorStop(0,n),o.addColorStop(.5,"hsl(300, 100%, 40%)"),o.addColorStop(1,n),r.fillStyle=o,r.translate(e,e),r.arc(0,0,t,0,2*Math.PI),r.fillStyle=o,r.fill(),a}();return{color:n,paint:function(t,n,r){t.drawImage(a,n-e,r-e)}}}function k(t){var n="hsl(0, 0%, 90%)",e=t+2,a=function(){var a=document.createElement("canvas");a.width=a.height=2*e;var r=a.getContext("2d"),i=-t/2,o=r.createRadialGradient(0,i,0,0,i,2*t);return o.addColorStop(0,n),o.addColorStop(.5,"hsl(0, 0%, 70%)"),o.addColorStop(1,n),r.fillStyle=o,r.translate(e,e),r.arc(0,0,t,0,2*Math.PI),r.fillStyle=o,r.fill(),a}();return{color:n,paint:function(t,n,r){t.drawImage(a,n-e,r-e)}}}function I(t){var n="hsl(60, 90%, 70%)",e=t+2,a=function(){var a=document.createElement("canvas");a.width=a.height=2*e;var r=a.getContext("2d"),i=-t/2,o=r.createRadialGradient(0,i,0,0,i,2*t);return o.addColorStop(0,n),o.addColorStop(.5,"hsl(60, 90%, 40%)"),o.addColorStop(1,n),r.fillStyle=o,r.translate(e,e),r.arc(0,0,t,0,2*Math.PI),r.fillStyle=o,r.fill(),a}();return{color:n,paint:function(t,n,r){t.drawImage(a,n-e,r-e)}}}!function(){var t=u();document.body.appendChild(t.element)}()}();
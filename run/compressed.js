!function(){function n(n,a,t,r){var e=t/2,i=8*r,o=4*r,l=e-o/2,c=e+i,u=Math.asin(l/c),d=Math.sqrt(1-Math.pow(l/c,2))*c,v=t+i+o,f=n/2,s=a-v,h=document.createElement("canvas");h.width=n,h.height=v;var m=h.getContext("2d");return m.lineJoin=m.lineCap="round",m.translate(f,v-e),m.moveTo(-f+o,-l),m.lineTo(-d,-l),m.arc(0,0,c,-Math.PI+u,-u),m.lineTo(f-o,-l),m.strokeStyle="#555",m.lineWidth=o,m.stroke(),{paint:function(n){n.drawImage(h,0,s)}}}function a(n,a){var t=document.createElement("canvas");t.width=n,t.height=a;var r=t.getContext("2d");return{c:r,canvas:t,clear:function(){r.fillStyle="rgba(0, 0, 0, 0.3)",r.fillRect(0,0,n,a)}}}function t(n,a){function t(n,a){var t=e[n];if(t){var i=t[a];i&&!u[i.id]&&(u[i.id]=i,i.shape.isBomb&&r(i))}}function r(n){var a=n.colNumber,r=n.rowNumber;t(a-2,r),t(a+2,r),t(a-1,r-1),t(a+1,r-1),t(a-1,r+1),t(a+1,r+1)}var e={};for(var i in n){var o=n[i];e[i]={};for(var l in o){var c=o[l];e[i][c.rowNumber]=c}}for(var u={},i=0;i<a.length;i++){var d=a[i];u[d.id]=d,d.shape.isBomb&&r(d)}return u}function r(n,a){for(var t=6*n,r=24,e=[],i=0;r>i;i++){var o=t*(r-i)/r,l=o+1,c=document.createElement("canvas");c.width=c.height=2*l;var u=c.getContext("2d");u.fillStyle=a,u.translate(l,l),u.arc(0,0,o,0,2*Math.PI),u.fill(),e.push(c)}return e}function e(n,a,t,r){var e,i,o=0,l=t.particleCanvases;t.isBomb?(e=3*r,i=10):(e=2*r,i=5);for(var c=[],u=0;i>u;u++){var d=x(e,e),v=x(e,e);c.push({x:n+d[0],y:a+d[1],dx:v[0],dy:v[1]})}return{id:Math.random(),paint:function(r){o||t.paint(r,n,a);for(var e in c){var i=l[o],u=c[e],d=u.x-i.width/2,v=u.y-i.height/2;r.drawImage(i,d,v)}},tick:function(){for(var n in c){var a=c[n];a.x+=a.dx,a.y+=a.dy}return o++,o==l.length?!0:void 0}}}function i(n){var a={};return{add:function(t,r,i){var o=e(t,r,i,n);a[o.id]=o},paint:function(n){for(var t in a)a[t].paint(n)},tick:function(){for(var n in a)a[n].tick()&&delete a[n]}}}function o(n,a,t){var r=[];for(var e in n){var i=n[e];for(var o in a){var l=a[o],c=l.x-i.x,u=l.y-i.y,d=Math.sqrt(c*c+u*u);if(t>d){r.push({movingBubble:i,stillBubble:l,distance:d});break}}}return r}function l(n){var a={};return{add:function(t,r,e){var i=c(t,r,e,n);a[i.id]=i},paint:function(n){for(var t in a)a[t].paint(n)},tick:function(){for(var n in a)a[n].tick()&&delete a[n]}}}function c(n,a,t,r){var e=32,i=e,o=1,l=6*(2*Math.random()-1)*r,c=0;return{id:Math.random(),paint:function(r){r.globalAlpha=o,t.paint(r,n,a),r.globalAlpha=1},tick:function(){return n+=l,a+=c,c+=r,l*=.95,i--,i?(o=i/e,void 0):!0}}}function u(n,a,t,r,e,i){var o=2*Math.max(n,a),l=n/2,c=a-t;return{paint:function(n,a,t,e){var u=a-l,d=t-c,v=Math.sqrt(u*u+d*d),f=u*o/v,s=d*o/v;-i>d/v&&(n.beginPath(),n.moveTo(l,c),n.lineTo(l+f,c+s),n.lineWidth=r,n.lineCap="round",n.strokeStyle=e,n.stroke())}}}function d(n,a,t,r,e){var i=t+", "+r+"%, "+e+"%",o=a.createLinearGradient(0,0,0,n);return o.addColorStop(0,"hsla("+i+", 0)"),o.addColorStop(1,"hsla("+i+", 0.2)"),o}function v(n,a,t){var r=(n-n*t)/2,e=(a-a*t)/2,i=document.createElement("canvas");return i.className="MainCanvas",i.width=n,i.height=a,i.style.transform="scale("+1/t+") translate("+r+"px, "+e+"px)",i}function f(){function t(){var n=da.get();return p(X,U,W,n)}function r(){if(ya){var n=xa-X/2,a=U-W-Ca,t=Math.sqrt(n*n+a*a),r=n/t,e=-a/t;if(-Ba>e&&Pa&&Pa.ready){var i=Pa.shape;Na.add(i,r,e),Pa=null,Ta=10,La=null,ya=!1}}}function e(){return!Pa||!Pa.ready||ga.showing||ga.hiding?!0:ga.visible?(ga.hide(),wa.reset(),ba.reset(),!0):void 0}function c(n){xa=n.clientX*b-ka,Ca=n.clientY*b-Ia}function d(n){xa=n.clientX*b-ka,Ca=n.clientY*b-Ia,ya=!0}function f(){requestAnimationFrame(function(){var n=Date.now();fa.clear(),Sa.clearRect(0,0,X,U),ha.paint(sa),ba.paint(sa),wa.paint(sa),ya&&Ea.paint(sa,xa,Ca,Pa.shape.laserGradient),Pa&&Pa.paint(sa),Na.paint(sa),ma.paint(sa),pa.paint(sa),ga.visible&&ga.paint(sa),Sa.drawImage(fa.canvas,0,0),K.innerHTML="repaint "+(Date.now()-n),f()})}function s(){for(var n=0;2>n;n++){var a=Date.now();wa.tick(),Na.tick(),ma.tick(),pa.tick(),ga.visible&&ga.tick();for(var r=o(Na.movingBubbles,wa.stillBubbles,Y),e=0;e<r.length;e++){var i=r[e],l=i.movingBubble;l.shiftBack(B-i.distance),m(l),Na.remove(l)}Ta?(Ta--,Ta||(Pa=t())):Pa&&Pa.tick(),z.innerHTML="tick "+(Date.now()-a)}}function m(n){wa.add(n),Ra++,Ra===Aa&&(Ra=0,wa.shift())}var b=devicePixelRatio,g=innerWidth*b,x=innerHeight*b,N=9+Math.floor((g-300)/200),B=Math.floor(g/N),E=B/40,W=B/2,F=Math.sin(Math.PI/3)*B,J=W-1*E,Y=2*J,X=g-g%B,U=x-x%B,j="MainPanel",z=document.createElement("div"),K=document.createElement("div"),Q=document.createElement("div");Q.className=j+"-debug",Q.appendChild(K),Q.appendChild(z);var V=k(J,E),Z=I(U,J,E),$=S(J,E),_=P(U,J,E),na=T(J,E),aa=D(U,J,E),ta=L(J,E),ra=O(U,J,E),ea=G(J,E),ia=R(U,J,E),oa=A(J,E),la=q(U,J,E),ca=H(J,E),ua=function(){var n={black:{normal:V},blue:{normal:Z,bomb:$},green:{normal:_,bomb:na},red:{normal:aa,bomb:ta},violet:{normal:ra,bomb:ea},white:{normal:ia,bomb:oa},yellow:{normal:la,bomb:ca}};return function(a){var t;return t=a.isBomb?"bomb":"normal",n[a.colorName][t]}}(),da=w();da.add(1,Z),da.add(1,_),da.add(1,aa),da.add(1,ra),da.add(1,ia),da.add(1,la);var va=w();va.add(3,V),va.add(8,Z),va.add(1,$),va.add(8,_),va.add(1,na),va.add(8,aa),va.add(1,ta),va.add(8,ra),va.add(1,ea),va.add(8,ia),va.add(1,oa),va.add(8,la),va.add(1,ca);var fa=a(X,U),sa=fa.c,ha=n(X,U,B,E),ma=i(E),pa=l(E),ba=M(U,B,E),ga=C(X,U,E),wa=y(U,W,N,B,va.get,F,ma.add,pa.add,ba.add,function(){var n=ba.get();ga.show(n,Da),n>Da&&(Da=n,localStorage.highScore=Da)});wa.reset();var xa,Ca,Na=h(X,U,W,Y,m,E),ya=!1,Ma=v(g,x,b),ka=(g-X)/2,Ia=(x-U)/2,Sa=Ma.getContext("2d");Sa.translate(ka,Ia);var Ba=.2,Ea=u(X,U,W,Y,Sa,Ba),Pa=t(),Ta=0,Da=parseInt(localStorage.highScore,10);isFinite(Da)||(Da=0);var La=null,Oa=!1,Ga=document.createElement("div");Ga.className=j,Ga.appendChild(Ma),Ga.appendChild(Q),Ga.addEventListener("mousedown",function(n){if(Oa)Oa=!1;else{if(e())return;ya||d(n)}}),Ga.addEventListener("touchstart",function(n){if(!e()&&!ya){var a=n.changedTouches[0];La=a.identifier,d(a)}}),addEventListener("mousemove",function(n){Oa?Oa=!1:c(n)}),Ga.addEventListener("touchmove",function(n){Oa=!0,n.preventDefault();for(var a=n.changedTouches,t=0;t<a.length;t++){var r=a[t];r.identifier===La&&c(r)}}),addEventListener("mouseup",function(n){Oa?Oa=!1:r(n)}),Ga.addEventListener("touchend",function(n){Oa=!0,n.preventDefault();for(var a=n.changedTouches,t=0;t<a.length;t++){var e=a[t];e.identifier===La&&r(e)}});var Ra=0,Aa=7;return addEventListener("beforeunload",function(){localStorage.state=JSON.stringify({score:ba.get(),stillCanvas:wa.getData()})}),addEventListener("keydown",function(n){32==n.keyCode&&s()}),setInterval(s,30),f(),function(){var n=localStorage.state;if(n){var a=JSON.parse(n);ba.add(a.score),wa.setData(a.stillCanvas,ua)}}(),{element:Ga}}function s(n,a,t,r,e,i,o,l){var c=20*l,u=i*c,d=o*c,v={id:Math.random(),shape:e,x:n/2,y:a-t,paint:function(n){e.paint(n,v.x,v.y)},shiftBack:function(a){var r=Math.sqrt(i*i+o*o);v.x-=i*a/r,v.y-=o*a/r;var e=t-v.x;e>0&&(v.x+=2*e);var l=v.x+t-n;l>0&&(v.x-=2*l)},tick:function(){v.x+=u,v.y+=d;var a=t-v.x;a>0&&(v.x+=2*a,i=-i,u=i*c);var r=v.x+t-n;return r>0&&(v.x-=2*r,i=-i,u=i*c),v.y<=t?(v.y=t,!0):void 0}};return v}function h(n,a,t,r,e,i){function o(n){delete l[n.id]}var l={};return{movingBubbles:l,remove:o,add:function(e,o,c){var u=s(n,a,t,r,e,o,c,i);l[u.id]=u},paint:function(n){for(var a in l)l[a].paint(n)},tick:function(){for(var n in l){var a=l[n];a.tick()&&(e(a),o(a))}}}}function m(n,a){function t(n,a){var t=e[n];if(t){var i=t[a];i&&!d[i.id]&&i.shape.colorName==u.colorName&&r(i)}}function r(n){var a=n.colNumber,r=n.rowNumber;d[n.id]=n,v.push(n),t(a-2,r),t(a+2,r),t(a-1,r-1),t(a+1,r-1),t(a-1,r+1),t(a+1,r+1)}var e={};for(var i in a){var o=a[i];e[i]={};for(var l in o){var c=o[l];e[i][c.rowNumber]=c}}var u=n.shape,d={},v=[];return r(n),v}function p(n,a,t,r){var e=n/2,i=a+t,o=8,l=0,c=2*t/o,u={ready:!1,shape:r,paint:function(n){n.globalAlpha=l/o,r.paint(n,e,i),n.globalAlpha=1},tick:function(){o>l?(l++,i-=c):u.ready=!0}};return u}function b(n){function a(n,a){var r=i[n];if(r){var o=r[a];if(o){var l=o.id;v[l]||(v[l]=!0,delete e[l],t(o))}}}function t(n){var t=n.colNumber,r=n.rowNumber;a(t-1,r-1),a(t+1,r-1),a(t-2,r),a(t+2,r),a(t-1,r+1),a(t+1,r+1)}var r=[],e={},i={};for(var o in n){var l=n[o];i[o]={};for(var c in l){var u=l[c],d=u.rowNumber;d?(i[o][d]=u,e[u.id]=u):r.push(u)}}for(var v={},o=0;o<r.length;o++)t(r[o]);return e}function g(n,a){for(var t=6*n,r=16,e=[],i=0;r>i;i++){var o=t*(r-i)/r,l=o+1,c=document.createElement("canvas");c.width=c.height=2*l;var u=c.getContext("2d");u.fillStyle=a,u.translate(l,l),u.arc(0,0,o,0,2*Math.PI),u.fill(),e.push(c)}return e}function w(){var n=[],a=0;return{add:function(t,r){n.push({chance:t,shape:r}),a+=t},get:function(){var t=Math.random()*a;for(var r in n){var e=n[r];if(t-=e.chance,0>t)return e.shape}}}}function x(n,a){var t=Math.random()*Math.PI*2,r=n+Math.random()*a,e=Math.cos(t)*r,i=Math.sin(t)*r;return[e,i]}function C(n,a,t){function r(){l&&l--,l||(f.visible=!1,f.hiding=!1),u=l/c}function e(){c>l?l++:f.showing=!1,u=l/c}var i,o,l=0,c=24,u=0,d=26*t,v="bold "+d+"px Arial, sans-serif",f={tick:e,hiding:!1,showing:!1,visible:!1,hide:function(){f.showing=!1,f.tick=r,f.hiding=!0},paint:function(t){var r=Math.pow(u,.25);t.fillStyle="rgba(0, 0, 0, "+.7*r+")",t.fillRect(0,0,n,a);var e=n/2,l=a/4+a*r/4-1.5*d;t.translate(e,l),t.fillStyle="rgba(255, 255, 255, "+r+")",t.textAlign="center",t.textBaseline="top",t.font=v,t.fillText("YOUR SCORE: "+i,0,0),i>o?t.fillText("NEW RECORD!",0,2*d):t.fillText("HIGH SCORE: "+o,0,2*d),t.translate(-e,-l)},show:function(n,a){i=n,o=a,f.visible=!0,f.hiding=!1,f.tick=e,f.showing=!0}};return f}function N(n,a,t,r,e){var i={colNumber:e,id:Math.random(),rowNumber:r,shape:t,x:n,y:a,paint:function(a){t.paint(a,n,i.y)}};return i}function y(n,a,r,e,i,o,l,c,u,d){function v(n){var a=n.id;M[a]=n,I[n.colNumber][a]=n,f(n)}function f(n){!T.gameOver&&n.rowNumber>=B&&(T.gameOver=!0,d())}function s(n,t){for(var r=a+n*a,l=a-o-C,c=0;t>c;c++){var u=i(),d=N(r,l,u,0,n);v(d),h(d,w+y),r+=e,n+=2}}function h(n,a){var t=n.id;k[t]?k[t].steps+=a:k[t]={steps:a,bubble:n}}function p(n){var a=n.id;delete M[a],delete I[n.colNumber][a]}function g(){for(var n in M){var a=M[n];h(a,w),a.rowNumber++,f(a)}E?s(1,r-1):s(0,r),E=!E,C+=o,y+=w}for(var w=4,x=o/w,C=0,y=0,M={},k={},I={},S=0;2*r-1>S;S++)I[S]={};var B=Math.floor((n-e)/o),E=!1,P=3,T={gameOver:!1,shift:g,stillBubbles:M,add:function(n){var r=n.y,i=y*x-a,d=Math.round((r+i)/o);r=d*o-i;var f=(d+(E?1:0))%2?a:0,s=n.x;s=Math.round((s-f)/e)*e+f;var g=Math.floor(s/a)-1,w=N(s,r,n.shape,d,g);v(w),y&&h(w,y);var C=m(w,I);if(C.length>=P){var M=t(I,C),k=0;for(var S in M){var B=M[S];p(B),l(B.x,B.y,B.shape),k++}u(k-P+1);var T=b(I);for(var S in T){var D=T[S];p(D),c(D.x,D.y,D.shape)}}},getData:function(){var n={bubbles:[],shiftIndex:y};for(var a in M){var t=M[a],r=t.shape;n.bubbles.push({colNumber:t.colNumber,rowNumber:t.rowNumber,shape:{colorName:r.colorName,isBomb:r.isBomb}})}return n},isOdd:function(){return E},paint:function(n){for(var a in M)M[a].paint(n)},reset:function(){T.gameOver=!1,k={};for(var n in M)delete M[n];for(var n in I){var a=I[n];for(var n in a)delete a[n]}g(),g(),g()},setData:function(n,t){y=Math.max(0,Math.floor(n.shiftIndex)),isFinite(y)||(y=0),C=y*o;for(var r in M)delete M[r];for(var r in I){var e=I[r];for(var r in e)delete e[r]}for(var r in k)delete k[r];var i=n.bubbles;for(var r in i){var l=i[r],c=t(l.shape);if(c){var u=l.colNumber,d=l.rowNumber,f=a+u*a,s=a+d*o,h=N(f,s,c,d,u);v(h)}}},tick:function(){for(var n in k){var a=k[n];a.steps--,a.bubble.y+=x,a.steps||(delete k[n],n--)}y&&(y--,C-=x)}};return T}function M(n,a,t){var r=0,e=10*t,i=n-a+10*t,o="bold "+26*t+"px Arial, sans-serif";return{add:function(n){r+=n},get:function(){return r},paint:function(n){n.textBaseline="top",n.font=o,n.fillStyle="#777",n.fillText(r,e,i)},reset:function(){r=0}}}function k(n,a){var t="hsl(0, 0%, 40%)",r=n+2,e=E(t,"hsl(0, 0%, 15%)",n);return{color:t,colorName:"black",particleCanvases:g(a,t),paint:function(n,a,t){n.drawImage(e,a-r,t-r)}}}function I(n,a,t){var r="hsl(220, 100%, 70%)",e=a+2,i=E(r,"hsl(220, 100%, 55%)",a),o=i.getContext("2d");return{color:r,colorName:"blue",laserGradient:d(n,o,220,100,70),particleCanvases:g(t,r),paint:function(n,a,t){n.drawImage(i,a-e,t-e)}}}function S(n,a){var t="hsl(220, 100%, 70%)",e=n+2,i=E(t,"hsl(220, 100%, 55%)",n);return B(i,n),{color:t,colorName:"blue",isBomb:!0,particleCanvases:r(a,t),paint:function(n,a,t){n.drawImage(i,a-e,t-e)}}}function B(n,a){var t=n.getContext("2d"),r="rgba(255 ,255, 255, 0.4)";t.beginPath(),t.arc(0,0,.25*a,0,2*Math.PI),t.fillStyle=r,t.fill();var e=3,i=2*Math.PI/e,o=.62*a,l=Math.PI/3;t.lineWidth=.45*a,t.beginPath(),t.rotate(Math.PI/2-l/2);for(var c=0;e>c;c++)t.moveTo(o,0),t.arc(0,0,o,0,l),t.rotate(i);t.strokeStyle=r,t.stroke()}function E(n,a,t){var r=t+2,e=document.createElement("canvas");e.width=e.height=2*r;var i=e.getContext("2d"),o=-t/2,l=i.createRadialGradient(0,o,0,0,o,2*t);return l.addColorStop(0,n),l.addColorStop(.5,a),l.addColorStop(1,n),i.fillStyle=l,i.translate(r,r),i.arc(0,0,t,0,2*Math.PI),i.fillStyle=l,i.fill(),e}function P(n,a,t){var r="hsl(100, 100%, 40%)",e=a+2,i=E(r,"hsl(100, 100%, 30%)",a),o=i.getContext("2d");return{color:r,colorName:"green",laserGradient:d(n,o,100,100,40),particleCanvases:g(t,r),paint:function(n,a,t){n.drawImage(i,a-e,t-e)}}}function T(n,a){var t="hsl(100, 100%, 40%)",e=n+2,i=E(t,"hsl(100, 100%, 30%)",n);return B(i,n),{color:t,colorName:"green",isBomb:!0,particleCanvases:r(a,t),paint:function(n,a,t){n.drawImage(i,a-e,t-e)}}}function D(n,a,t){var r="hsl(5, 100%, 65%)",e=a+2,i=E(r,"hsl(5, 100%, 40%)",a),o=i.getContext("2d");return{color:r,colorName:"red",laserGradient:d(n,o,5,100,65),particleCanvases:g(t,r),paint:function(n,a,t){n.drawImage(i,a-e,t-e)}}}function L(n,a){var t="hsl(5, 100%, 65%)",e=n+2,i=E(t,"hsl(5, 100%, 40%)",n);return B(i,n),{color:t,colorName:"red",isBomb:!0,particleCanvases:r(a,t),paint:function(n,a,t){n.drawImage(i,a-e,t-e)}}}function O(n,a,t){var r="hsl(300, 100%, 60%)",e=a+2,i=E(r,"hsl(300, 100%, 40%)",a),o=i.getContext("2d");return{color:r,colorName:"violet",laserGradient:d(n,o,300,100,60),particleCanvases:g(t,r),paint:function(n,a,t){n.drawImage(i,a-e,t-e)}}}function G(n,a){var t="hsl(300, 100%, 60%)",e=n+2,i=E(t,"hsl(300, 100%, 40%)",n);return B(i,n),{color:t,colorName:"violet",isBomb:!0,particleCanvases:r(a,t),paint:function(n,a,t){n.drawImage(i,a-e,t-e)}}}function R(n,a,t){var r="hsl(0, 0%, 90%)",e=a+2,i=E(r,"hsl(0, 0%, 70%)",a),o=i.getContext("2d");return{color:r,colorName:"white",laserGradient:d(n,o,0,0,90),particleCanvases:g(t,r),paint:function(n,a,t){n.drawImage(i,a-e,t-e)}}}function A(n,a){var t="hsl(0, 0%, 90%)",e=n+2,i=E(t,"hsl(0, 0%, 70%)",n);return B(i,n),{color:t,colorName:"white",isBomb:!0,particleCanvases:r(a,t),paint:function(n,a,t){n.drawImage(i,a-e,t-e)}}}function q(n,a,t){var r="hsl(60, 90%, 70%)",e=a+2,i=E(r,"hsl(60, 90%, 40%)",a),o=i.getContext("2d");return{color:r,colorName:"yellow",laserGradient:d(n,o,60,90,70),particleCanvases:g(t,r),paint:function(n,a,t){n.drawImage(i,a-e,t-e)}}}function H(n,a){var t="hsl(60, 90%, 70%)",e=n+2,i=E(t,"hsl(60, 90%, 40%)",n);return B(i,n),{color:t,colorName:"yellow",isBomb:!0,particleCanvases:r(a,t),paint:function(n,a,t){n.drawImage(i,a-e,t-e)}}}!function(){var n=f();document.body.appendChild(n.element)}()}();
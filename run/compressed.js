!function(){function n(n,t,a,r){var e=a/2,i=8*r,o=4*r,d=e-o/2,c=e+i,u=Math.asin(d/c),l=Math.sqrt(1-Math.pow(d/c,2))*c,f=a+i+o,v=n/2,h=t-f,s=document.createElement("canvas");s.width=n,s.height=f;var p=s.getContext("2d");return p.lineJoin=p.lineCap="round",p.translate(v,f-e),p.moveTo(-v+o,-d),p.lineTo(-l,-d),p.arc(0,0,c,-Math.PI+u,-u),p.lineTo(v-o,-d),p.strokeStyle="#555",p.lineWidth=o,p.stroke(),{paint:function(n){n.drawImage(s,0,h)}}}function t(n,t){var a=document.createElement("canvas");a.width=n,a.height=t;var r=a.getContext("2d");return{c:r,canvas:a,clear:function(){r.fillStyle="rgba(0, 0, 0, 0.4)",r.fillRect(0,0,n,t)}}}function a(n,t,a,r){for(var e=16,i=e,o=2*Math.PI,d=2*r,c=[],u=0;6>u;u++){var l=g(d,d),f=g(d,d);c.push({x:n+l[0],y:t+l[1],dx:f[0],dy:f[1]})}return{id:Math.random(),paint:function(d){i==e&&a.paint(d,n,t);for(var u in c){var l=c[u],f=l.x,v=l.y;d.beginPath(),d.moveTo(f,v),d.fillStyle=a.color,d.arc(f,v,4*i/e*r,0,o),d.fill()}},tick:function(){for(var n in c){var t=c[n];t.x+=t.dx,t.y+=t.dy}return i--,i?void 0:!0}}}function r(n){var t={};return{add:function(r,e,i){var o=a(r,e,i,n);t[o.id]=o},paint:function(n){for(var a in t)t[a].paint(n)},tick:function(){for(var n in t)t[n].tick()&&delete t[n]}}}function e(n,t,a){var r=[];for(var e in n){var i=n[e];for(var o in t){var d=t[o],c=d.x-i.x,u=d.y-i.y,l=Math.hypot(c,u);if(a>l){r.push({movingBubble:i,stillBubble:d,distance:l});break}}}return r}function i(n){var t={};return{add:function(a,r,e){var i=o(a,r,e,n);t[i.id]=i},paint:function(n){for(var a in t)t[a].paint(n)},tick:function(){for(var n in t)t[n].tick()&&delete t[n]}}}function o(n,t,a,r){var e=32,i=e,o=1,d=6*(2*Math.random()-1)*r,c=0;return{id:Math.random(),paint:function(r){r.globalAlpha=o,a.paint(r,n,t),r.globalAlpha=1},tick:function(){return n+=d,t+=c,c+=r,d*=.95,i--,i?void(o=i/e):!0}}}function d(n,t,a,r,e,i){var o=2*Math.max(n,t),d=n/2,c=t-a;return{paint:function(n,t,a,e){var u=t-d,l=a-c,f=Math.hypot(u,l),v=u*o/f,h=l*o/f;-i>l/f&&(n.beginPath(),n.moveTo(d,c),n.lineTo(d+v,c+h),n.lineWidth=r,n.lineCap="round",n.strokeStyle=e,n.stroke())}}}function c(n,t,a,r,e){var i=a+", "+r+"%, "+e+"%",o=t.createLinearGradient(0,0,0,n);return o.addColorStop(0,"hsla("+i+", 0)"),o.addColorStop(1,"hsla("+i+", 0.2)"),o}function u(n,t,a){var r=(n-n*a)/2,e=(t-t*a)/2,i=document.createElement("canvas");return i.className="MainCanvas",i.width=n,i.height=t,i.style.transform="scale("+1/a+") translate("+r+"px, "+e+"px)",i}function l(){function a(){var n=j.get();return s(R,D,x,n)}function o(){requestAnimationFrame(function(){var n=Date.now();K.clear(),ut.clearRect(0,0,R,D),U.paint(Q),_.paint(Q),tt.paint(Q),it&&vt.paint(Q,at,rt,ht.shape.laserGradient),ht&&ht.paint(Q),et.paint(Q),Z.paint(Q),$.paint(Q),nt.visible&&nt.paint(Q),ut.drawImage(K.canvas,0,0),A.innerHTML="repaint "+(Date.now()-n),o()})}function c(){var n=Date.now();tt.tick(),et.tick(),Z.tick(),$.tick(),nt.visible&&nt.tick(),ht&&ht.tick();for(var t=e(et.movingBubbles,tt.stillBubbles,G),a=0;a<t.length;a++){var r=t[a],i=r.movingBubble;i.shiftBack(g-r.distance),l(i),et.remove(i)}L.innerHTML="tick "+(Date.now()-n)}function l(n){tt.add(n),mt++,mt===gt&&(mt=0,tt.shift())}var f=devicePixelRatio,h=innerWidth*f,p=innerHeight*f,g=40*f,x=g/2,C=Math.sin(Math.PI/3)*g,B=x-1*f,G=2*B,P="MainPanel",L=document.createElement("div"),A=document.createElement("div"),O=document.createElement("div");O.className=P+"-debug",O.appendChild(A),O.appendChild(L);var R=h-h%g,D=p-p%g,H=M(B),W=k(D,B),q=I(D,B),X=N(D,B),Y=T(D,B),F=S(D,B),J=E(D,B),j=m();j.add(1,W),j.add(1,q),j.add(1,X),j.add(1,Y),j.add(1,F),j.add(1,J);var z=m();z.add(1,H),z.add(2,W),z.add(2,q),z.add(2,X),z.add(2,Y),z.add(2,F),z.add(2,J);var K=t(R,D),Q=K.c,U=n(R,D,g,f),V=Math.floor(h/g),Z=r(f),$=i(f),_=w(D,g,f),nt=b(R,D),tt=y(D,x,V,g,z.get,C,Z.add,$.add,_.add,nt.show);tt.reset();var at,rt,et=v(R,D,x,G,l,f),it=!1,ot=u(h,p,f),dt=(h-R)/2,ct=(p-D)/2,ut=ot.getContext("2d");ut.translate(dt,ct);var lt,ft=.2,vt=d(R,D,x,G,ut,ft),ht=a(),st=null,pt=document.createElement("div");pt.className=P,pt.appendChild(ot),pt.appendChild(O),pt.addEventListener("touchstart",function(n){if(ht&&ht.ready&&!nt.showing&&!nt.hiding){if(nt.visible)return nt.hide(),tt.reset(),void _.reset();if(null===st){var t=n.changedTouches[0];at=t.clientX*f-dt,rt=t.clientY*f-ct,st=t.identifier,it=!0}}}),pt.addEventListener("touchmove",function(n){for(var t=n.changedTouches,a=0;a<t.length;a++){var r=t[a];r.identifier===st&&(at=r.clientX*f-dt,rt=r.clientY*f-ct)}}),pt.addEventListener("touchend",function(n){for(var t=n.changedTouches,r=0;r<t.length;r++){var e=t[r];if(e.identifier===st){it=!1;var e=n.changedTouches[0],i=at-R/2,o=D-x-rt,d=Math.hypot(i,o),c=i/d,u=-o/d;if(-ft>u){var l=ht.shape;et.add(l,c,u),ht=null,lt=setTimeout(function(){ht=a()},200),st=null}}}});var mt=0,gt=7;return addEventListener("keydown",function(n){32==n.keyCode&&c()}),setInterval(c,20),o(),{element:pt}}function f(n,t,a,r,e,i,o,d){var c=20*d,u=i*c,l=o*c,f={id:Math.random(),shape:e,x:n/2,y:t-a,paint:function(n){e.paint(n,f.x,f.y)},shiftBack:function(t){var r=Math.hypot(i,o);f.x-=i*t/r,f.y-=o*t/r;var e=a-f.x;e>0&&(f.x+=2*e);var d=f.x+a-n;d>0&&(f.x-=2*d)},tick:function(){f.x+=u,f.y+=l;var t=a-f.x;t>0&&(f.x+=2*t,i=-i,u=i*c);var r=f.x+a-n;return r>0&&(f.x-=2*r,i=-i,u=i*c),f.y<=a?(f.y=a,!0):void 0}};return f}function v(n,t,a,r,e,i){function o(n){delete d[n.id]}var d={};return{movingBubbles:d,remove:o,add:function(e,o,c){var u=f(n,t,a,r,e,o,c,i);d[u.id]=u},paint:function(n){for(var t in d)d[t].paint(n)},tick:function(){for(var n in d){var t=d[n];t.tick()&&(e(t),o(t))}}}}function h(n,t){function a(n,t){var a=e[n];if(a){var i=a[t];i&&!l[i.id]&&i.shape==u&&r(i)}}function r(n){var t=n.colNumber,r=n.rowNumber;l[n.id]=n,f.push(n),a(t-2,r),a(t+2,r),a(t-1,r-1),a(t+1,r-1),a(t-1,r+1),a(t+1,r+1)}var e={};for(var i in t){var o=t[i];e[i]={};for(var d in o){var c=o[d];e[i][c.rowNumber]=c}}var u=n.shape,l={},f=[];return r(n),f}function s(n,t,a,r){var e=n/2,i=t+a,o=8,d=0,c=2*a/o,u={ready:!1,shape:r,paint:function(n){n.globalAlpha=d/o,r.paint(n,e,i),n.globalAlpha=1},tick:function(){o>d?(d++,i-=c):u.ready=!0}};return u}function p(n){function t(n,t){var r=i[n];if(r){var o=r[t];if(o){var d=o.id;f[d]||(f[d]=!0,delete e[d],a(o))}}}function a(n){var a=n.colNumber,r=n.rowNumber;t(a-1,r-1),t(a+1,r-1),t(a-2,r),t(a+2,r),t(a-1,r+1),t(a+1,r+1)}var r=[],e={},i={};for(var o in n){var d=n[o];i[o]={};for(var c in d){var u=d[c],l=u.rowNumber;l?(i[o][l]=u,e[u.id]=u):r.push(u)}}for(var f={},o=0;o<r.length;o++)a(r[o]);return e}function m(){var n=[],t=0;return{add:function(a,r){n.push({chance:a,shape:r}),t+=a},get:function(){var a=Math.random()*t;for(var r in n){var e=n[r];if(a-=e.chance,0>a)return e.shape}}}}function g(n,t){var a=Math.random()*Math.PI*2,r=n+Math.random()*t,e=Math.cos(a)*r,i=Math.sin(a)*r;return[e,i]}function b(n,t){function a(){e&&e--,e||(d.visible=!1,d.hiding=!1),o=e/i}function r(){i>e?e++:d.showing=!1,o=e/i}var e=0,i=24,o=0,d={tick:r,hiding:!1,showing:!1,visible:!1,hide:function(){d.showing=!1,d.tick=a,d.hiding=!0},paint:function(a){a.fillStyle="rgba(0, 0, 0, "+.7*o+")",a.fillRect(0,0,n,t)},show:function(){d.visible=!0,d.hiding=!1,d.tick=r,d.showing=!0}};return d}function x(n,t,a,r,e){var i={colNumber:e,id:Math.random(),rowNumber:r,shape:a,x:n,y:t,paint:function(t){a.paint(t,n,i.y)}};return i}function y(n,t,a,r,e,i,o,d,c,u){function l(n){var t=n.id;k[t]=n,I[n.colNumber][t]=n,f(n)}function f(n){!B.gameOver&&n.rowNumber>=T&&(B.gameOver=!0,u())}function v(n,a){for(var o=t+n*t,d=t-i-w,c=0;a>c;c++){var u=e(),f=x(o,d,u,0,n);l(f),s(f,b+M),o+=r,n+=2}}function s(n,t){var a=n.id;C[a]?C[a].steps+=t:C[a]={steps:t,bubble:n}}function m(n){var t=n.id;delete k[t],delete I[n.colNumber][t]}function g(){for(var n in k){var t=k[n];s(t,b),t.rowNumber++,f(t)}S?v(1,a-1):v(0,a),S=!S,w+=i,M+=b}for(var b=4,y=i/b,w=0,M=0,k={},C={},I={},N=0;2*a-1>N;N++)I[N]={};var T=Math.floor((n-r)/i),S=!1,E=3,B={gameOver:!1,shift:g,stillBubbles:k,add:function(n){var a=n.y,e=M*y-t,u=Math.round((a+e)/i);a=u*i-e;var f=(u+(S?1:0))%2?t:0,v=n.x;v=Math.round((v-f)/r)*r+f;var g=Math.floor(v/t)-1,b=x(v,a,n.shape,u,g);l(b),M&&s(b,M);var w=h(b,I);if(w.length>=E){c(w.length-E+1);for(var k=0;k<w.length;k++){var C=w[k];m(C),o(C.x,C.y,C.shape)}var N=p(I);for(var k in N){var T=N[k];m(T),d(T.x,T.y,T.shape)}}},isOdd:function(){return S},paint:function(n){for(var t in k)k[t].paint(n)},reset:function(){B.gameOver=!1,C={};for(var n in k)delete k[n];for(var n in I){var t=I[n];for(var n in t)delete t[n]}g(),g(),g()},tick:function(){for(var n in C){var t=C[n];t.steps--,t.bubble.y+=y,t.steps||(delete C[n],n--)}M&&(M--,w-=y)}};return B}function w(n,t,a){var r=0,e=10*a,i=n-t+10*a,o="bold "+26*a+"px Arial, sans-serif";return{add:function(n){r+=n},paint:function(n){n.textBaseline="top",n.font=o,n.fillStyle="#777",n.fillText(r,e,i)},reset:function(){r=0}}}function M(n){var t="hsl(0, 0%, 40%)",a=n+2,r=C(t,"hsl(0, 0%, 15%)",n);return{color:t,paint:function(n,t,e){n.drawImage(r,t-a,e-a)}}}function k(n,t){var a="hsl(220, 100%, 70%)",r=t+2,e=C(a,"hsl(220, 100%, 55%)",t),i=e.getContext("2d");return{color:a,laserGradient:c(n,i,220,100,70),paint:function(n,t,a){n.drawImage(e,t-r,a-r)}}}function C(n,t,a){var r=a+2,e=document.createElement("canvas");e.width=e.height=2*r;var i=e.getContext("2d"),o=-a/2,d=i.createRadialGradient(0,o,0,0,o,2*a);return d.addColorStop(0,n),d.addColorStop(.5,t),d.addColorStop(1,n),i.fillStyle=d,i.translate(r,r),i.arc(0,0,a,0,2*Math.PI),i.fillStyle=d,i.fill(),e}function I(n,t){var a="hsl(100, 100%, 40%)",r=t+2,e=C(a,"hsl(100, 100%, 30%)",t),i=e.getContext("2d");return{color:a,laserGradient:c(n,i,100,100,40),paint:function(n,t,a){n.drawImage(e,t-r,a-r)}}}function N(n,t){var a="hsl(5, 100%, 65%)",r=t+2,e=C(a,"hsl(5, 100%, 40%)",t),i=e.getContext("2d");return{color:a,laserGradient:c(n,i,5,100,65),paint:function(n,t,a){n.drawImage(e,t-r,a-r)}}}function T(n,t){var a="hsl(300, 100%, 60%)",r=t+2,e=C(a,"hsl(300, 100%, 40%)",t),i=e.getContext("2d");return{color:a,laserGradient:c(n,i,300,100,60),paint:function(n,t,a){n.drawImage(e,t-r,a-r)}}}function S(n,t){var a="hsl(0, 0%, 90%)",r=t+2,e=C(a,"hsl(0, 0%, 70%)",t),i=e.getContext("2d");return{color:a,laserGradient:c(n,i,0,0,90),paint:function(n,t,a){n.drawImage(e,t-r,a-r)}}}function E(n,t){var a="hsl(60, 90%, 70%)",r=t+2,e=C(a,"hsl(60, 90%, 40%)",t),i=e.getContext("2d");return{color:a,laserGradient:c(n,i,60,90,70),paint:function(n,t,a){n.drawImage(e,t-r,a-r)}}}!function(){var n=l();document.body.appendChild(n.element)}()}();
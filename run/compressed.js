!function(){function n(n,t,e,a){var r=e/2,i=8*a,o=4*a,l=r-o/2,c=r+i,d=Math.asin(l/c),u=Math.sqrt(1-Math.pow(l/c,2))*c,f=e+i+o,v=n/2,h=t-f,s=document.createElement("canvas");s.width=n,s.height=f;var p=s.getContext("2d");return p.lineJoin=p.lineCap="round",p.translate(v,f-r),p.moveTo(-v+o,-l),p.lineTo(-u,-l),p.arc(0,0,c,-Math.PI+d,-d),p.lineTo(v-o,-l),p.strokeStyle="#555",p.lineWidth=o,p.stroke(),{paint:function(n){n.drawImage(s,0,h)}}}function t(n,t){var e=document.createElement("canvas");e.width=n,e.height=t;var a=e.getContext("2d");return{c:a,canvas:e,clear:function(){a.fillStyle="rgba(0, 0, 0, 0.4)",a.fillRect(0,0,n,t)}}}function e(n,t,e,a){for(var r=16,i=r,o=2*Math.PI,l=2*a,c=[],d=0;6>d;d++){var u=b(l,l),f=b(l,l);c.push({x:n+u[0],y:t+u[1],dx:f[0],dy:f[1]})}return{id:Math.random(),paint:function(l){i==r&&e.paint(l,n,t);for(var d in c){var u=c[d],f=u.x,v=u.y;l.beginPath(),l.moveTo(f,v),l.fillStyle=e.color,l.arc(f,v,4*i/r*a,0,o),l.fill()}},tick:function(){for(var n in c){var t=c[n];t.x+=t.dx,t.y+=t.dy}return i--,i?void 0:!0}}}function a(n){var t={};return{add:function(a,r,i){var o=e(a,r,i,n);t[o.id]=o},paint:function(n){for(var e in t)t[e].paint(n)},tick:function(){for(var n in t)t[n].tick()&&delete t[n]}}}function r(n,t,e){var a=[];for(var r in n){var i=n[r];for(var o in t){var l=t[o],c=l.x-i.x,d=l.y-i.y,u=Math.hypot(c,d);if(e>u){a.push({movingBubble:i,stillBubble:l,distance:u});break}}}return a}function i(n){var t={};return{add:function(e,a,r){var i=o(e,a,r,n);t[i.id]=i},paint:function(n){for(var e in t)t[e].paint(n)},tick:function(){for(var n in t)t[n].tick()&&delete t[n]}}}function o(n,t,e,a){var r=32,i=r,o=1,l=6*(2*Math.random()-1)*a,c=0;return{id:Math.random(),paint:function(a){a.globalAlpha=o,e.paint(a,n,t),a.globalAlpha=1},tick:function(){return n+=l,t+=c,c+=a,l*=.95,i--,i?void(o=i/r):!0}}}function l(n,t,e,a,r,i){var o=2*Math.max(n,t),l=n/2,c=t-e;return{paint:function(n,t,e,r){var d=t-l,u=e-c,f=Math.hypot(d,u),v=d*o/f,h=u*o/f;-i>u/f&&(n.beginPath(),n.moveTo(l,c),n.lineTo(l+v,c+h),n.lineWidth=a,n.lineCap="round",n.strokeStyle=r,n.stroke())}}}function c(n,t,e,a,r){var i=e+", "+a+"%, "+r+"%",o=t.createLinearGradient(0,0,0,n);return o.addColorStop(0,"hsla("+i+", 0)"),o.addColorStop(1,"hsla("+i+", 0.2)"),o}function d(n,t,e){var a=(n-n*e)/2,r=(t-t*e)/2,i=document.createElement("canvas");return i.className="MainCanvas",i.width=n,i.height=t,i.style.transform="scale("+1/e+") translate("+a+"px, "+r+"px)",i}function u(){function e(){var n=tt.get();return s(W,Y,R,n)}function o(){var n=vt-W/2,t=Y-R-ht,a=Math.hypot(n,t),r=n/a,i=-t/a;if(-wt>i&&kt){var o=kt.shape;st.add(o,r,i),kt=null,yt=setTimeout(function(){kt=e()},200),Nt=null,pt=!1}}function c(){return!kt||!kt.ready||ut.showing||ut.hiding?!0:ut.visible?(ut.hide(),ft.reset(),dt.reset(),!0):void 0}function u(n){vt=n.clientX*x-bt,ht=n.clientY*x-gt}function f(n){vt=n.clientX*x-bt,ht=n.clientY*x-gt,pt=!0}function h(){requestAnimationFrame(function(){var n=Date.now();at.clear(),xt.clearRect(0,0,W,Y),it.paint(rt),dt.paint(rt),ft.paint(rt),pt&&Mt.paint(rt,vt,ht,kt.shape.laserGradient),kt&&kt.paint(rt),st.paint(rt),lt.paint(rt),ct.paint(rt),ut.visible&&ut.paint(rt),xt.drawImage(at.canvas,0,0),_.innerHTML="repaint "+(Date.now()-n),h()})}function p(){var n=Date.now();ft.tick(),st.tick(),lt.tick(),ct.tick(),ut.visible&&ut.tick(),kt&&kt.tick();for(var t=r(st.movingBubbles,ft.stillBubbles,P),e=0;e<t.length;e++){var a=t[e],i=a.movingBubble;i.shiftBack(G-a.distance),b(i),st.remove(i)}D.innerHTML="tick "+(Date.now()-n)}function b(n){ft.add(n),Et++,Et===It&&(Et=0,ft.shift())}var x=devicePixelRatio,C=innerWidth*x,T=innerHeight*x,G=40*x,R=G/2,L=Math.sin(Math.PI/3)*G,O=R-1*x,P=2*O,A="MainPanel",D=document.createElement("div"),_=document.createElement("div"),H=document.createElement("div");H.className=A+"-debug",H.appendChild(_),H.appendChild(D);var W=C-C%G,Y=T-T%G,q=M(O),F=k(Y,O),X=BubbleShape_BlueBomb(O),J=N(Y,O),U=BubbleShape_GreenBomb(O),V=S(Y,O),j=BubbleShape_RedBomb(O),z=B(Y,O),K=BubbleShape_VioletBomb(O),Q=E(Y,O),Z=BubbleShape_WhiteBomb(O),$=I(Y,O),nt=BubbleShape_YellowBomb(O),tt=m();tt.add(1,F),tt.add(1,J),tt.add(1,V),tt.add(1,z),tt.add(1,Q),tt.add(1,$);var et=m();et.add(3,q),et.add(8,F),et.add(1,X),et.add(8,J),et.add(1,U),et.add(8,V),et.add(1,j),et.add(8,z),et.add(1,K),et.add(8,Q),et.add(1,Z),et.add(8,$),et.add(1,nt);var at=t(W,Y),rt=at.c,it=n(W,Y,G,x),ot=Math.floor(C/G),lt=a(x),ct=i(x),dt=w(Y,G,x),ut=g(W,Y,x),ft=y(Y,R,ot,G,et.get,L,lt.add,ct.add,dt.add,function(){var n=dt.get();ut.show(n,Ct),n>Ct&&(Ct=n,localStorage.highScore=Ct)});ft.reset();var vt,ht,st=v(W,Y,R,P,b,x),pt=!1,mt=d(C,T,x),bt=(C-W)/2,gt=(T-Y)/2,xt=mt.getContext("2d");xt.translate(bt,gt);var yt,wt=.2,Mt=l(W,Y,R,P,xt,wt),kt=e(),Ct=parseInt(localStorage.highScore,10);isFinite(Ct)||(Ct=0);var Nt=null,St=!1,Bt=document.createElement("div");Bt.className=A,Bt.appendChild(mt),Bt.appendChild(H),Bt.addEventListener("mousedown",function(n){if(St)St=!1;else{if(c())return;pt||f(n)}}),Bt.addEventListener("touchstart",function(n){if(!c()&&!pt){var t=n.changedTouches[0];Nt=t.identifier,f(t)}}),Bt.addEventListener("mousemove",function(n){St?St=!1:u(n)}),Bt.addEventListener("touchmove",function(n){St=!0,n.preventDefault();for(var t=n.changedTouches,e=0;e<t.length;e++){var a=t[e];a.identifier===Nt&&u(a)}}),Bt.addEventListener("mouseup",function(n){St?St=!1:o(n)}),Bt.addEventListener("touchend",function(n){St=!0,n.preventDefault();for(var t=n.changedTouches,e=0;e<t.length;e++){var a=t[e];a.identifier===Nt&&o(a)}});var Et=0,It=7;return addEventListener("keydown",function(n){32==n.keyCode&&p()}),setInterval(p,20),h(),{element:Bt}}function f(n,t,e,a,r,i,o,l){var c=20*l,d=i*c,u=o*c,f={id:Math.random(),shape:r,x:n/2,y:t-e,paint:function(n){r.paint(n,f.x,f.y)},shiftBack:function(t){var a=Math.hypot(i,o);f.x-=i*t/a,f.y-=o*t/a;var r=e-f.x;r>0&&(f.x+=2*r);var l=f.x+e-n;l>0&&(f.x-=2*l)},tick:function(){f.x+=d,f.y+=u;var t=e-f.x;t>0&&(f.x+=2*t,i=-i,d=i*c);var a=f.x+e-n;return a>0&&(f.x-=2*a,i=-i,d=i*c),f.y<=e?(f.y=e,!0):void 0}};return f}function v(n,t,e,a,r,i){function o(n){delete l[n.id]}var l={};return{movingBubbles:l,remove:o,add:function(r,o,c){var d=f(n,t,e,a,r,o,c,i);l[d.id]=d},paint:function(n){for(var t in l)l[t].paint(n)},tick:function(){for(var n in l){var t=l[n];t.tick()&&(r(t),o(t))}}}}function h(n,t){function e(n,t){var e=r[n];if(e){var i=e[t];i&&!u[i.id]&&i.shape.colorName==d.colorName&&a(i)}}function a(n){var t=n.colNumber,a=n.rowNumber;u[n.id]=n,f.push(n),e(t-2,a),e(t+2,a),e(t-1,a-1),e(t+1,a-1),e(t-1,a+1),e(t+1,a+1)}var r={};for(var i in t){var o=t[i];r[i]={};for(var l in o){var c=o[l];r[i][c.rowNumber]=c}}var d=n.shape,u={},f=[];return a(n),f}function s(n,t,e,a){var r=n/2,i=t+e,o=8,l=0,c=2*e/o,d={ready:!1,shape:a,paint:function(n){n.globalAlpha=l/o,a.paint(n,r,i),n.globalAlpha=1},tick:function(){o>l?(l++,i-=c):d.ready=!0}};return d}function p(n){function t(n,t){var a=i[n];if(a){var o=a[t];if(o){var l=o.id;f[l]||(f[l]=!0,delete r[l],e(o))}}}function e(n){var e=n.colNumber,a=n.rowNumber;t(e-1,a-1),t(e+1,a-1),t(e-2,a),t(e+2,a),t(e-1,a+1),t(e+1,a+1)}var a=[],r={},i={};for(var o in n){var l=n[o];i[o]={};for(var c in l){var d=l[c],u=d.rowNumber;u?(i[o][u]=d,r[d.id]=d):a.push(d)}}for(var f={},o=0;o<a.length;o++)e(a[o]);return r}function m(){var n=[],t=0;return{add:function(e,a){n.push({chance:e,shape:a}),t+=e},get:function(){var e=Math.random()*t;for(var a in n){var r=n[a];if(e-=r.chance,0>e)return r.shape}}}}function b(n,t){var e=Math.random()*Math.PI*2,a=n+Math.random()*t,r=Math.cos(e)*a,i=Math.sin(e)*a;return[r,i]}function g(n,t,e){function a(){l&&l--,l||(v.visible=!1,v.hiding=!1),d=l/c}function r(){c>l?l++:v.showing=!1,d=l/c}var i,o,l=0,c=24,d=0,u=26*e,f="bold "+u+"px Arial, sans-serif",v={tick:r,hiding:!1,showing:!1,visible:!1,hide:function(){v.showing=!1,v.tick=a,v.hiding=!0},paint:function(e){var a=Math.pow(d,.25);e.fillStyle="rgba(0, 0, 0, "+.7*a+")",e.fillRect(0,0,n,t);var r=n/2,l=t/4+t*a/4-1.5*u;e.translate(r,l),e.fillStyle="rgba(255, 255, 255, "+a+")",e.textAlign="center",e.textBaseline="top",e.font=f,e.fillText("YOUR SCORE: "+i,0,0),i>o?e.fillText("NEW RECORD!",0,2*u):e.fillText("HIGH SCORE: "+o,0,2*u),e.translate(-r,-l)},show:function(n,t){i=n,o=t,v.visible=!0,v.hiding=!1,v.tick=r,v.showing=!0}};return v}function x(n,t,e,a,r){var i={colNumber:r,id:Math.random(),rowNumber:a,shape:e,x:n,y:t,paint:function(t){e.paint(t,n,i.y)}};return i}function y(n,t,e,a,r,i,o,l,c,d){function u(n){var t=n.id;k[t]=n,N[n.colNumber][t]=n,f(n)}function f(n){!T.gameOver&&n.rowNumber>=B&&(T.gameOver=!0,d())}function v(n,e){for(var o=t+n*t,l=t-i-w,c=0;e>c;c++){var d=r(),f=x(o,l,d,0,n);u(f),s(f,g+M),o+=a,n+=2}}function s(n,t){var e=n.id;C[e]?C[e].steps+=t:C[e]={steps:t,bubble:n}}function m(n){var t=n.id;delete k[t],delete N[n.colNumber][t]}function b(){for(var n in k){var t=k[n];s(t,g),t.rowNumber++,f(t)}E?v(1,e-1):v(0,e),E=!E,w+=i,M+=g}for(var g=4,y=i/g,w=0,M=0,k={},C={},N={},S=0;2*e-1>S;S++)N[S]={};var B=Math.floor((n-a)/i),E=!1,I=3,T={gameOver:!1,shift:b,stillBubbles:k,add:function(n){var e=n.y,r=M*y-t,d=Math.round((e+r)/i);e=d*i-r;var f=(d+(E?1:0))%2?t:0,v=n.x;v=Math.round((v-f)/a)*a+f;var b=Math.floor(v/t)-1,g=x(v,e,n.shape,d,b);u(g),M&&s(g,M);var w=h(g,N);if(w.length>=I){var k=BombNeighbors(N,w),C=0;for(var S in k){var B=k[S];m(B),o(B.x,B.y,B.shape),C++}c(C-I+1);var T=p(N);for(var S in T){var G=T[S];m(G),l(G.x,G.y,G.shape)}}},isOdd:function(){return E},paint:function(n){for(var t in k)k[t].paint(n)},reset:function(){T.gameOver=!1,C={};for(var n in k)delete k[n];for(var n in N){var t=N[n];for(var n in t)delete t[n]}b(),b(),b()},tick:function(){for(var n in C){var t=C[n];t.steps--,t.bubble.y+=y,t.steps||(delete C[n],n--)}M&&(M--,w-=y)}};return T}function w(n,t,e){var a=0,r=10*e,i=n-t+10*e,o="bold "+26*e+"px Arial, sans-serif";return{add:function(n){a+=n},get:function(){return a},paint:function(n){n.textBaseline="top",n.font=o,n.fillStyle="#777",n.fillText(a,r,i)},reset:function(){a=0}}}function M(n){var t="hsl(0, 0%, 40%)",e=n+2,a=C(t,"hsl(0, 0%, 15%)",n);return{color:t,colorName:"black",paint:function(n,t,r){n.drawImage(a,t-e,r-e)}}}function k(n,t){var e="hsl(220, 100%, 70%)",a=t+2,r=C(e,"hsl(220, 100%, 55%)",t),i=r.getContext("2d");return{color:e,colorName:"blue",laserGradient:c(n,i,220,100,70),paint:function(n,t,e){n.drawImage(r,t-a,e-a)}}}function C(n,t,e){var a=e+2,r=document.createElement("canvas");r.width=r.height=2*a;var i=r.getContext("2d"),o=-e/2,l=i.createRadialGradient(0,o,0,0,o,2*e);return l.addColorStop(0,n),l.addColorStop(.5,t),l.addColorStop(1,n),i.fillStyle=l,i.translate(a,a),i.arc(0,0,e,0,2*Math.PI),i.fillStyle=l,i.fill(),r}function N(n,t){var e="hsl(100, 100%, 40%)",a=t+2,r=C(e,"hsl(100, 100%, 30%)",t),i=r.getContext("2d");return{color:e,colorName:"green",laserGradient:c(n,i,100,100,40),paint:function(n,t,e){n.drawImage(r,t-a,e-a)}}}function S(n,t){var e="hsl(5, 100%, 65%)",a=t+2,r=C(e,"hsl(5, 100%, 40%)",t),i=r.getContext("2d");return{color:e,colorName:"red",laserGradient:c(n,i,5,100,65),paint:function(n,t,e){n.drawImage(r,t-a,e-a)}}}function B(n,t){var e="hsl(300, 100%, 60%)",a=t+2,r=C(e,"hsl(300, 100%, 40%)",t),i=r.getContext("2d");return{color:e,colorName:"violet",laserGradient:c(n,i,300,100,60),paint:function(n,t,e){n.drawImage(r,t-a,e-a)}}}function E(n,t){var e="hsl(0, 0%, 90%)",a=t+2,r=C(e,"hsl(0, 0%, 70%)",t),i=r.getContext("2d");return{color:e,colorName:"white",laserGradient:c(n,i,0,0,90),paint:function(n,t,e){n.drawImage(r,t-a,e-a)}}}function I(n,t){var e="hsl(60, 90%, 70%)",a=t+2,r=C(e,"hsl(60, 90%, 40%)",t),i=r.getContext("2d");return{color:e,colorName:"yellow",laserGradient:c(n,i,60,90,70),paint:function(n,t,e){n.drawImage(r,t-a,e-a)}}}!function(){var n=u();document.body.appendChild(n.element)}()}();
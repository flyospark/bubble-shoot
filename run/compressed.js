!function(){function n(n,a,t,e){var r=t/2,i=8*e,o=4*e,l=r-o/2,c=r+i,d=Math.asin(l/c),u=Math.sqrt(1-Math.pow(l/c,2))*c,v=t+i+o,s=n/2,f=a-v,h=document.createElement("canvas");h.width=n,h.height=v;var m=h.getContext("2d");return m.lineJoin=m.lineCap="round",m.translate(s,v-r),m.moveTo(-s+o,-l),m.lineTo(-u,-l),m.arc(0,0,c,-Math.PI+d,-d),m.lineTo(s-o,-l),m.strokeStyle="#555",m.lineWidth=o,m.stroke(),{paint:function(n){n.drawImage(h,0,f)}}}function a(n,a){var t=document.createElement("canvas");t.width=n,t.height=a;var e=t.getContext("2d");return{c:e,canvas:t,clear:function(){e.fillStyle="rgba(0, 0, 0, 0.3)",e.fillRect(0,0,n,a)}}}function t(n,a){function t(n,a){var t=r[n];if(t){var i=t[a];i&&!d[i.id]&&(d[i.id]=i,i.shape.isBomb&&e(i))}}function e(n){var a=n.colNumber,e=n.rowNumber;t(a-2,e),t(a+2,e),t(a-1,e-1),t(a+1,e-1),t(a-1,e+1),t(a+1,e+1)}var r={};for(var i in n){var o=n[i];r[i]={};for(var l in o){var c=o[l];r[i][c.rowNumber]=c}}for(var d={},i=0;i<a.length;i++){var u=a[i];d[u.id]=u,u.shape.isBomb&&e(u)}return d}function e(n,a){for(var t=6*n,e=24,r=[],i=0;e>i;i++){var o=t*(e-i)/e,l=o+1,c=document.createElement("canvas");c.width=c.height=2*l;var d=c.getContext("2d");d.fillStyle=a,d.translate(l,l),d.arc(0,0,o,0,2*Math.PI),d.fill(),r.push(c)}return r}function r(n,a,t,e){var r,i,o=0,l=t.particleCanvases;t.isBomb?(r=3*e,i=10):(r=2*e,i=5);for(var c=[],d=0;i>d;d++){var u=x(r,r),v=x(r,r);c.push({x:n+u[0],y:a+u[1],dx:v[0],dy:v[1]})}return{id:Math.random(),paint:function(e){o||t.paint(e,n,a);for(var r in c){var i=l[o],d=c[r],u=d.x-i.width/2,v=d.y-i.height/2;e.drawImage(i,u,v)}},tick:function(){for(var n in c){var a=c[n];a.x+=a.dx,a.y+=a.dy}return o++,o==l.length?!0:void 0}}}function i(n){var a={};return{add:function(t,e,i){var o=r(t,e,i,n);a[o.id]=o},paint:function(n){for(var t in a)a[t].paint(n)},tick:function(){for(var n in a)a[n].tick()&&delete a[n]}}}function o(n,a,t){var e=[];for(var r in n){var i=n[r];for(var o in a){var l=a[o],c=l.x-i.x,d=l.y-i.y,u=Math.sqrt(c*c+d*d);if(t>u){e.push({movingBubble:i,stillBubble:l,distance:u});break}}}return e}function l(n){var a={};return{add:function(t,e,r){var i=c(t,e,r,n);a[i.id]=i},paint:function(n){for(var t in a)a[t].paint(n)},tick:function(){for(var n in a)a[n].tick()&&delete a[n]}}}function c(n,a,t,e){var r=32,i=r,o=1,l=6*(2*Math.random()-1)*e,c=0;return{id:Math.random(),paint:function(e){e.globalAlpha=o,t.paint(e,n,a),e.globalAlpha=1},tick:function(){return n+=l,a+=c,c+=e,l*=.95,i--,i?(o=i/r,void 0):!0}}}function d(n,a,t,e,r,i){var o=2*Math.max(n,a),l=n/2,c=a-t;return{paint:function(n,a,t,r){var d=a-l,u=t-c,v=Math.sqrt(d*d+u*u),s=d*o/v,f=u*o/v;-i>u/v&&(n.beginPath(),n.moveTo(l,c),n.lineTo(l+s,c+f),n.lineWidth=e,n.lineCap="round",n.strokeStyle=r,n.stroke())}}}function u(n,a,t,e,r){var i=t+", "+e+"%, "+r+"%",o=a.createLinearGradient(0,0,0,n);return o.addColorStop(0,"hsla("+i+", 0)"),o.addColorStop(1,"hsla("+i+", 0.2)"),o}function v(n,a,t){var e=(n-n*t)/2,r=(a-a*t)/2,i=document.createElement("canvas");return i.className="MainCanvas",i.width=n,i.height=a,i.style.transform="scale("+1/t+") translate("+e+"px, "+r+"px)",i}function s(){function t(){var n=sa.get();return p(j,z,J,n)}function e(){if(ka){var n=Na-j/2,a=z-J-ya,t=Math.sqrt(n*n+a*a),e=n/t,r=-a/t;if(-Pa>r&&La&&La.ready){var i=La.shape;Ma.add(i,e,r),La=null,Da=10,Ga=null,ka=!1}}}function r(){return!La||!La.ready||xa.showing||xa.hiding?!0:xa.visible?(xa.hide(),Ca.reset(),wa.reset(),!0):void 0}function c(n){Na=n.clientX*x-Sa,ya=n.clientY*x-Ba}function u(n){Na=n.clientX*x-Sa,ya=n.clientY*x-Ba,ka=!0}function s(){requestAnimationFrame(function(){var n=Date.now();ha.clear(),Ea.clearRect(0,0,j,z),pa.paint(ma),wa.paint(ma),Ca.paint(ma),ka&&Ta.paint(ma,Na,ya,La.shape.laserGradient),La&&La.paint(ma),Ma.paint(ma),ba.paint(ma),ga.paint(ma),xa.visible&&xa.paint(ma),Ea.drawImage(ha.canvas,0,0),V.innerHTML="repaint "+(Date.now()-n),s()})}function f(n){var a;return a=n.isBomb?"bomb":"normal",va[n.colorName][a]}function m(){localStorage.state=JSON.stringify({width:N,height:B,dpp:x,score:wa.get(),stillCanvas:Ca.getData(),nextBubbleColorName:La?La.shape.colorName:null})}function b(){for(var n=0;2>n;n++){var a=Date.now();Ca.tick(),Ma.tick(),ba.tick(),ga.tick(),xa.visible&&xa.tick();for(var e=o(Ma.movingBubbles,Ca.stillBubbles,U),r=0;r<e.length;r++){var i=e[r],l=i.movingBubble;l.shiftBack(W-i.distance),g(l),Ma.remove(l)}Da?(Da--,Da||(La=t())):La&&La.tick(),Q.innerHTML="tick "+(Date.now()-a)}}function g(n){Ca.add(n),qa++,qa===Ha&&(qa=0,Ca.shift())}var x=devicePixelRatio,N=innerWidth*x,B=innerHeight*x,E=9+Math.floor((N-300)/200),W=Math.floor(N/E),F=W/40,J=W/2,Y=Math.sin(Math.PI/3)*W,X=J-1*F,U=2*X,j=N-N%W,z=B-B%W,K="MainPanel",Q=document.createElement("div"),V=document.createElement("div"),Z=document.createElement("div");Z.className=K+"-debug",Z.appendChild(V),Z.appendChild(Q);var $=k(X,F),_=I(z,X,F),na=S(X,F),aa=P(z,X,F),ta=T(X,F),ea=L(z,X,F),ra=D(X,F),ia=O(z,X,F),oa=G(X,F),la=R(z,X,F),ca=A(X,F),da=q(z,X,F),ua=H(X,F),va={black:{normal:$},blue:{normal:_,bomb:na},green:{normal:aa,bomb:ta},red:{normal:ea,bomb:ra},violet:{normal:ia,bomb:oa},white:{normal:la,bomb:ca},yellow:{normal:da,bomb:ua}},sa=w();sa.add(1,_),sa.add(1,aa),sa.add(1,ea),sa.add(1,ia),sa.add(1,la),sa.add(1,da);var fa=w();fa.add(5,$),fa.add(8,_),fa.add(1,na),fa.add(8,aa),fa.add(1,ta),fa.add(8,ea),fa.add(1,ra),fa.add(8,ia),fa.add(1,oa),fa.add(8,la),fa.add(1,ca),fa.add(8,da),fa.add(1,ua);var ha=a(j,z),ma=ha.c,pa=n(j,z,W,F),ba=i(F),ga=l(F),wa=M(z,W,F),xa=C(j,z,F),Ca=y(z,J,E,W,fa.get,Y,ba.add,ga.add,wa.add,function(){var n=wa.get();xa.show(n,Oa),n>Oa&&(Oa=n,localStorage.highScore=Oa)});Ca.reset();var Na,ya,Ma=h(j,z,J,U,g,F),ka=!1,Ia=v(N,B,x),Sa=(N-j)/2,Ba=(B-z)/2,Ea=Ia.getContext("2d");Ea.translate(Sa,Ba);var Pa=.2,Ta=d(j,z,J,U,Ea,Pa),La=t(),Da=0,Oa=parseInt(localStorage.highScore,10);isFinite(Oa)||(Oa=0);var Ga=null,Ra=!1,Aa=document.createElement("div");Aa.className=K,Aa.appendChild(Ia),Aa.appendChild(Z),Aa.addEventListener("mousedown",function(n){if(Ra)Ra=!1;else{if(r())return;ka||u(n)}}),Aa.addEventListener("touchstart",function(n){if(!r()&&!ka){var a=n.changedTouches[0];Ga=a.identifier,u(a)}}),addEventListener("mousemove",function(n){Ra?Ra=!1:c(n)}),Aa.addEventListener("touchmove",function(n){Ra=!0,n.preventDefault();for(var a=n.changedTouches,t=0;t<a.length;t++){var e=a[t];e.identifier===Ga&&c(e)}}),addEventListener("mouseup",function(n){Ra?Ra=!1:e(n)}),Aa.addEventListener("touchend",function(n){Ra=!0,n.preventDefault();for(var a=n.changedTouches,t=0;t<a.length;t++){var r=a[t];r.identifier===Ga&&e(r)}});var qa=0,Ha=7;return document.addEventListener("visibilitychange",function(){"hidden"==document.visibilityState&&m()}),addEventListener("beforeunload",m),addEventListener("keydown",function(n){32==n.keyCode&&b()}),setInterval(b,30),s(),function(){var n=localStorage.state;if(n){var a=JSON.parse(n);if(a.width==N&&a.height==B&&a.dpp==x){wa.add(a.score),Ca.setData(a.stillCanvas,f);var t=a.nextBubbleColorName;if(t){var e=va[t].normal;La=p(j,z,J,e)}}}}(),{element:Aa}}function f(n,a,t,e,r,i,o,l){var c=20*l,d=i*c,u=o*c,v={id:Math.random(),shape:r,x:n/2,y:a-t,paint:function(n){r.paint(n,v.x,v.y)},shiftBack:function(a){var e=Math.sqrt(i*i+o*o);v.x-=i*a/e,v.y-=o*a/e;var r=t-v.x;r>0&&(v.x+=2*r);var l=v.x+t-n;l>0&&(v.x-=2*l)},tick:function(){v.x+=d,v.y+=u;var a=t-v.x;a>0&&(v.x+=2*a,i=-i,d=i*c);var e=v.x+t-n;return e>0&&(v.x-=2*e,i=-i,d=i*c),v.y<=t?(v.y=t,!0):void 0}};return v}function h(n,a,t,e,r,i){function o(n){delete l[n.id]}var l={};return{movingBubbles:l,remove:o,add:function(r,o,c){var d=f(n,a,t,e,r,o,c,i);l[d.id]=d},paint:function(n){for(var a in l)l[a].paint(n)},tick:function(){for(var n in l){var a=l[n];a.tick()&&(r(a),o(a))}}}}function m(n,a){function t(n,a){var t=r[n];if(t){var i=t[a];i&&!u[i.id]&&i.shape.colorName==d.colorName&&e(i)}}function e(n){var a=n.colNumber,e=n.rowNumber;u[n.id]=n,v.push(n),t(a-2,e),t(a+2,e),t(a-1,e-1),t(a+1,e-1),t(a-1,e+1),t(a+1,e+1)}var r={};for(var i in a){var o=a[i];r[i]={};for(var l in o){var c=o[l];r[i][c.rowNumber]=c}}var d=n.shape,u={},v=[];return e(n),v}function p(n,a,t,e){var r=n/2,i=a+t,o=8,l=0,c=2*t/o,d={ready:!1,shape:e,paint:function(n){n.globalAlpha=l/o,e.paint(n,r,i),n.globalAlpha=1},tick:function(){o>l?(l++,i-=c):d.ready=!0}};return d}function b(n){function a(n,a){var e=i[n];if(e){var o=e[a];if(o){var l=o.id;v[l]||(v[l]=!0,delete r[l],t(o))}}}function t(n){var t=n.colNumber,e=n.rowNumber;a(t-1,e-1),a(t+1,e-1),a(t-2,e),a(t+2,e),a(t-1,e+1),a(t+1,e+1)}var e=[],r={},i={};for(var o in n){var l=n[o];i[o]={};for(var c in l){var d=l[c],u=d.rowNumber;u?(i[o][u]=d,r[d.id]=d):e.push(d)}}for(var v={},o=0;o<e.length;o++)t(e[o]);return r}function g(n,a){for(var t=6*n,e=16,r=[],i=0;e>i;i++){var o=t*(e-i)/e,l=o+1,c=document.createElement("canvas");c.width=c.height=2*l;var d=c.getContext("2d");d.fillStyle=a,d.translate(l,l),d.arc(0,0,o,0,2*Math.PI),d.fill(),r.push(c)}return r}function w(){var n=[],a=0;return{add:function(t,e){n.push({chance:t,shape:e}),a+=t},get:function(){var t=Math.random()*a;for(var e in n){var r=n[e];if(t-=r.chance,0>t)return r.shape}}}}function x(n,a){var t=Math.random()*Math.PI*2,e=n+Math.random()*a,r=Math.cos(t)*e,i=Math.sin(t)*e;return[r,i]}function C(n,a,t){function e(){l&&l--,l||(s.visible=!1,s.hiding=!1),d=l/c}function r(){c>l?l++:s.showing=!1,d=l/c}var i,o,l=0,c=24,d=0,u=26*t,v="bold "+u+"px Arial, sans-serif",s={tick:r,hiding:!1,showing:!1,visible:!1,hide:function(){s.showing=!1,s.tick=e,s.hiding=!0},paint:function(t){var e=Math.pow(d,.25);t.fillStyle="rgba(0, 0, 0, "+.7*e+")",t.fillRect(0,0,n,a);var r=n/2,l=a/4+a*e/4-1.5*u;t.translate(r,l),t.fillStyle="rgba(255, 255, 255, "+e+")",t.textAlign="center",t.textBaseline="top",t.font=v,t.fillText("YOUR SCORE: "+i,0,0),i>o?t.fillText("NEW RECORD!",0,2*u):t.fillText("HIGH SCORE: "+o,0,2*u),t.translate(-r,-l)},show:function(n,a){i=n,o=a,s.visible=!0,s.hiding=!1,s.tick=r,s.showing=!0}};return s}function N(n,a,t,e,r){var i={colNumber:r,id:Math.random(),rowNumber:e,shape:t,x:n,y:a,paint:function(a){t.paint(a,n,i.y)}};return i}function y(n,a,e,r,i,o,l,c,d,u){function v(n){var a=n.id;M[a]=n,I[n.colNumber][a]=n,s(n)}function s(n){!T.gameOver&&n.rowNumber>=B&&(T.gameOver=!0,u())}function f(n,t){for(var e=a+n*a,l=a-o-C,c=0;t>c;c++){var d=i(),u=N(e,l,d,0,n);v(u),h(u,w+y),e+=r,n+=2}}function h(n,a){var t=n.id;k[t]?k[t].steps+=a:k[t]={steps:a,bubble:n}}function p(n){var a=n.id;delete M[a],delete I[n.colNumber][a]}function g(){for(var n in M){var a=M[n];h(a,w),a.rowNumber++,s(a)}E?f(1,e-1):f(0,e),E=!E,C+=o,y+=w}for(var w=4,x=o/w,C=0,y=0,M={},k={},I={},S=0;2*e-1>S;S++)I[S]={};var B=Math.floor((n-r)/o),E=!1,P=3,T={gameOver:!1,shift:g,stillBubbles:M,add:function(n){var e=n.y,i=y*x-a,u=Math.round((e+i)/o);e=u*o-i;var s=(u+(E?1:0))%2?a:0,f=n.x;f=Math.round((f-s)/r)*r+s;var g=Math.floor(f/a)-1,w=N(f,e,n.shape,u,g);v(w),y&&h(w,y);var C=m(w,I);if(C.length>=P){var M=t(I,C),k=0;for(var S in M){var B=M[S];p(B),l(B.x,B.y,B.shape),k++}d(k-P+1);var T=b(I);for(var S in T){var L=T[S];p(L),c(L.x,L.y,L.shape)}}},getData:function(){var n={odd:E,bubbles:[],shiftIndex:y};for(var a in M){var t=M[a],e=t.shape;n.bubbles.push({colNumber:t.colNumber,rowNumber:t.rowNumber,shape:{colorName:e.colorName,isBomb:e.isBomb}})}return n},isOdd:function(){return E},paint:function(n){for(var a in M)M[a].paint(n)},reset:function(){T.gameOver=!1,k={};for(var n in M)delete M[n];for(var n in I){var a=I[n];for(var n in a)delete a[n]}g(),g(),g()},setData:function(n,t){E=n.odd,y=Math.max(0,Math.floor(n.shiftIndex)),isFinite(y)||(y=0),C=y*o;for(var e in M)delete M[e];for(var e in I){var r=I[e];for(var e in r)delete r[e]}for(var e in k)delete k[e];var i=n.bubbles;for(var e in i){var l=i[e],c=t(l.shape);if(c){var d=l.colNumber,u=l.rowNumber,s=a+d*a,f=a+u*o,h=N(s,f,c,u,d);v(h)}}},tick:function(){for(var n in k){var a=k[n];a.steps--,a.bubble.y+=x,a.steps||(delete k[n],n--)}y&&(y--,C-=x)}};return T}function M(n,a,t){var e=0,r=10*t,i=n-a+10*t,o="bold "+26*t+"px Arial, sans-serif";return{add:function(n){e+=n},get:function(){return e},paint:function(n){n.textBaseline="top",n.font=o,n.fillStyle="#777",n.fillText(e,r,i)},reset:function(){e=0}}}function k(n,a){var t="hsl(0, 0%, 40%)",e=n+2,r=E(t,"hsl(0, 0%, 15%)",n);return{color:t,colorName:"black",particleCanvases:g(a,t),paint:function(n,a,t){n.drawImage(r,a-e,t-e)}}}function I(n,a,t){var e="hsl(220, 100%, 70%)",r=a+2,i=E(e,"hsl(220, 100%, 55%)",a),o=i.getContext("2d");return{color:e,colorName:"blue",laserGradient:u(n,o,220,100,70),particleCanvases:g(t,e),paint:function(n,a,t){n.drawImage(i,a-r,t-r)}}}function S(n,a){var t="hsl(220, 100%, 70%)",r=n+2,i=E(t,"hsl(220, 100%, 55%)",n);return B(i,n),{color:t,colorName:"blue",isBomb:!0,particleCanvases:e(a,t),paint:function(n,a,t){n.drawImage(i,a-r,t-r)}}}function B(n,a){var t=n.getContext("2d"),e="rgba(255 ,255, 255, 0.4)";t.beginPath(),t.arc(0,0,.25*a,0,2*Math.PI),t.fillStyle=e,t.fill();var r=3,i=2*Math.PI/r,o=.62*a,l=Math.PI/3;t.lineWidth=.45*a,t.beginPath(),t.rotate(Math.PI/2-l/2);for(var c=0;r>c;c++)t.moveTo(o,0),t.arc(0,0,o,0,l),t.rotate(i);t.strokeStyle=e,t.stroke()}function E(n,a,t){var e=t+2,r=document.createElement("canvas");r.width=r.height=2*e;var i=r.getContext("2d"),o=-t/2,l=i.createRadialGradient(0,o,0,0,o,2*t);return l.addColorStop(0,n),l.addColorStop(.5,a),l.addColorStop(1,n),i.fillStyle=l,i.translate(e,e),i.arc(0,0,t,0,2*Math.PI),i.fillStyle=l,i.fill(),r}function P(n,a,t){var e="hsl(100, 100%, 40%)",r=a+2,i=E(e,"hsl(100, 100%, 30%)",a),o=i.getContext("2d");return{color:e,colorName:"green",laserGradient:u(n,o,100,100,40),particleCanvases:g(t,e),paint:function(n,a,t){n.drawImage(i,a-r,t-r)}}}function T(n,a){var t="hsl(100, 100%, 40%)",r=n+2,i=E(t,"hsl(100, 100%, 30%)",n);return B(i,n),{color:t,colorName:"green",isBomb:!0,particleCanvases:e(a,t),paint:function(n,a,t){n.drawImage(i,a-r,t-r)}}}function L(n,a,t){var e="hsl(5, 100%, 65%)",r=a+2,i=E(e,"hsl(5, 100%, 40%)",a),o=i.getContext("2d");return{color:e,colorName:"red",laserGradient:u(n,o,5,100,65),particleCanvases:g(t,e),paint:function(n,a,t){n.drawImage(i,a-r,t-r)}}}function D(n,a){var t="hsl(5, 100%, 65%)",r=n+2,i=E(t,"hsl(5, 100%, 40%)",n);return B(i,n),{color:t,colorName:"red",isBomb:!0,particleCanvases:e(a,t),paint:function(n,a,t){n.drawImage(i,a-r,t-r)}}}function O(n,a,t){var e="hsl(300, 100%, 60%)",r=a+2,i=E(e,"hsl(300, 100%, 40%)",a),o=i.getContext("2d");return{color:e,colorName:"violet",laserGradient:u(n,o,300,100,60),particleCanvases:g(t,e),paint:function(n,a,t){n.drawImage(i,a-r,t-r)}}}function G(n,a){var t="hsl(300, 100%, 60%)",r=n+2,i=E(t,"hsl(300, 100%, 40%)",n);return B(i,n),{color:t,colorName:"violet",isBomb:!0,particleCanvases:e(a,t),paint:function(n,a,t){n.drawImage(i,a-r,t-r)}}}function R(n,a,t){var e="hsl(0, 0%, 90%)",r=a+2,i=E(e,"hsl(0, 0%, 70%)",a),o=i.getContext("2d");return{color:e,colorName:"white",laserGradient:u(n,o,0,0,90),particleCanvases:g(t,e),paint:function(n,a,t){n.drawImage(i,a-r,t-r)}}}function A(n,a){var t="hsl(0, 0%, 90%)",r=n+2,i=E(t,"hsl(0, 0%, 70%)",n);return B(i,n),{color:t,colorName:"white",isBomb:!0,particleCanvases:e(a,t),paint:function(n,a,t){n.drawImage(i,a-r,t-r)}}}function q(n,a,t){var e="hsl(60, 90%, 70%)",r=a+2,i=E(e,"hsl(60, 90%, 40%)",a),o=i.getContext("2d");return{color:e,colorName:"yellow",laserGradient:u(n,o,60,90,70),particleCanvases:g(t,e),paint:function(n,a,t){n.drawImage(i,a-r,t-r)}}}function H(n,a){var t="hsl(60, 90%, 70%)",r=n+2,i=E(t,"hsl(60, 90%, 40%)",n);return B(i,n),{color:t,colorName:"yellow",isBomb:!0,particleCanvases:e(a,t),paint:function(n,a,t){n.drawImage(i,a-r,t-r)}}}!function(){var n=s();document.body.appendChild(n.element)}()}();